/*
* Backbone.Siren v0.0.3
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
define(["jquery","underscore","backbone"],function(t,e,n){n.Siren=function(e,n){"use strict";function i(t,n){e.extend(this,t),this.parent=n}function r(t){return t.replace(/(\-[a-z])/g,function(t){return t.toUpperCase().replace("-","")})}function a(t){var e,n;return t.href?n=t.href:t.links?(e=t.links.filter(function(t){return!(!t.rel||!t.rel.filter(function(t){return"self"==t}).length)})[0],e&&(n=e.href)):(S('Missing href or "self" link'),n=""),n}function o(){return a(this._data)}function s(t){return t["class"]||[]}function c(t,n){return e.filter(t,function(t){return u(t,n)})}function u(t,e){var n=!0;return e.className&&(n=t.hasClass(e.className)),e.rel&&(n=t.rel()==e.rel),n}function l(t,e){var n=!0;return e.className&&(n=f(t,e.className)),e.name&&(n=t.name==e.name),n}function f(t,n){return e.indexOf(s(t),n)>-1}function h(t){return f(this._data,t)}function d(){return s(this._data)}function m(t){var n=this._data.links;return t&&(n=e.filter(n,function(n){return e.indexOf(n.rel,t)>-1})),n||[]}function p(n){var i=this,r=[],a=this.links(n);return e.each(a,function(e){r.push(t.getJSON(e.href,function(t){i.parseEntity(t)}))}),r}function v(t){var e=t.rel;return e&&(e=e[0],e=e.slice(e.lastIndexOf("/")+1,e.length)),e}function g(){return v(this._data)}function y(t){var n=this._actions;return t&&(n=e.filter(n,function(e){return l(e,t)})),n}function A(t){var i,r=this.getActionByName(t),a=this;return r&&(i={},e.each(r.fields,function(t){i[t.name]=a instanceof n.Model?a.get(t.name):a.meta(t.name)})),i}function b(t){return e.find(this._actions,function(e){return e.name==t})}function _(){return this._data.title}function N(){var t=this,i=[];return e.each(t._data.actions,function(a){var o=new n.Siren.Action(a,t);i.push(o),a.name?t[r(a.name)]=e.bind(o.execute,o):S("Action is missing a name, unable to add top level method",a)}),t._actions=i,i}var w={},M={add:function(t){return w[t.url()]=t},exists:function(t){return!!w[t.url()]},all:function(){return w}},S=function(){n.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return i.prototype={getFieldByName:function(t){return e.find(this.fields,function(e){return e.name==t})},execute:function(t){if(this.parent){var n={url:this.href,actionName:this.name,method:this.method,type:this.type,validate:!0,patch:!0};return t=e.extend(n,t),this.parent.save(this.parent.getAllByAction(this.name),t)}}},{settings:{showWarnings:!0},store:M,Action:i,Model:n.Model.extend({url:o,classes:d,hasClass:h,rel:g,title:_,actions:y,links:m,getActionByName:b,getAllByAction:A,parseActions:N,request:p,resolveEntities:function(n,i){var r=this,a=[];return e.each(n.entities,function(t){t.href&&"linked"==i.autoFetch||"all"==i.autoFetch?a.push(r.fetchEntity(t,i)):a.push(r.addEntity(t,i))}),t.when(a).done(function(){r.trigger("resolve",r)})},parse:function(t,e){return this._data=t,this._entities=[],this.resolveEntities(t,e),this.parseActions(e),t.properties},toJSON:function(){var t=e.clone(this.attributes),n=this.entities();return e.each(n,function(e){t[e.rel()]=e}),t},entities:function(t){var n=this,i=e.filter(this,function(t,i){return e.indexOf(n._entities,i)>-1});return t&&(i=c(i,t)),i},fetchEntity:function(e){var n=this;return t.getJSON(a(e),function(t){n.addEntity(t)})},parseEntity:function(t){var e;return f(t,"collection")?e=new n.Siren.Collection(t):f(t,"error")?S("@todo - errors"):(e=new n.Siren.Model(t),M.add(e)),e},addEntity:function(t){var e=this.parseEntity(t),n=e.rel();return this.set(n,e),this._entities.push(n),e},constructor:function(t,e){e=e||{},e.parse=!0,n.Model.call(this,t,e)}}),Collection:n.Collection.extend({url:o,classes:d,hasClass:h,title:_,rel:g,links:m,actions:y,getActionByName:b,getAllByAction:A,parseActions:N,request:p,toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},filter:function(t){return"function"==typeof t?e.filter(this,t):c(this,t)},parse:function(t,i){this._data=t,this._meta=t.properties||{};var r=[];return e.each(t.entities,function(t){var e=new n.Siren.Model(t);r.push(e),M.add(e)}),this.parseActions(i),r},meta:function(t){return this._meta[t]},constructor:function(t,e){e=e||{},e.parse=!0,n.Collection.call(this,t,e)}})}}(e,n),function(t,e){"use strict";t.extend(e.Siren.Model.prototype,{_validate:function(t,e){var n;return e.validate&&this.validate?(n=this.validationError=this.validate(t,e)||null)?(this.trigger("invalid",this,n,e||{}),!1):!0:!0},validateOne:function(){var t={valueMissing:!1,typeMismatch:!1,patternMismatch:!1,tooLong:!1,rangeUnderflow:!1,rangeOverflow:!1,stepMismatch:!1,badInput:!1,customError:!0,valid:!1};return t},validate:function(n,i){var r,a=this,o={};return r=this.getActionByName(i.actionName),r?t.isEmpty(n)&&(o["no-writable-fields"]='Malformed Siren: There were no writable fields for action "'+i.actionName+'"'):o["no-actions"]='Malformed Siren: There are no actions matching the name, "'+i.actionName+'"',t.each(n,function(t,n){var s,c,u,l;t instanceof e.Model?(s=r.getFieldByName(n),c=s.action,t._validate(t.getAllByAction(c),{validate:!0,actionName:c}),l=t.validationError,l&&(o[n]=l)):(u=a.validateOne(r.getFieldByName(n),t,i),u.valid||(o[n]=u))}),t.isEmpty(o)?void 0:o}})}(e,n),function(t,e){"use strict";t.extend(e.Siren.Model.prototype,{})}(e,n),function(e,n){"use strict";function i(t,e){return e=e||{},{id:e.id||t.name+"-form",enctype:e.enctype||t.type,method:e.method||t.method,action:e.action||t.href,title:e.title||t.title,novalidate:!e.validation}}function r(t,n){n=n||{};var i=[],r=t.fields;return e.each(r,function(r){var a;"entity"!=r.type?(a=r.name,i.push(e.extend({value:t.parent.get(a)},r,n[a]))):"entity"==r.type&&console.log("@todo - how to handle sub-entity views?")}),i}n.Siren.FormView=n.View.extend({tagName:"form",events:{submit:"handleFormSubmit","change input, select":"handleFormElementChange"},handleFormSubmit:function(t){t.preventDefault(),this.model.getActionByName(this.action.name).execute()},handleFormElementChange:function(e){var n=t(e.target),i={};i[n.attr("name")]=n.val(),this.model.set(i)},template:function(t){var n='<% _.each(fieldAttributes, function (field, fieldName) { %>                     <div>                         <label for="<%= field.id %>"><%= field.label %></label>                         <input type="<%= field.type %>" name="<%= field.name %>" id="<%= field.id %>" value="<%= field.value %>" />                     </div>                 <% }); %> <input type="submit" class="submitButton" />';return e.template(n)(t)},parseAction:function(t){var e;if(!t||!t.action)throw'Missing required property: "action"';if(e=t.action,!(e.parent instanceof n.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone Model';return{attributes:i(e,t.formAttributes),fieldAttributes:r(e,t.fieldAttributes),model:e.parent,action:e}},render:function(t){return this.$el.html(this.template(t))},_render:function(t){return this.render(t)},constructor:function(t){var e=this.parseAction(t);n.View.call(this,e),this.action=e.action,this._render(e)}})}(e,n)});
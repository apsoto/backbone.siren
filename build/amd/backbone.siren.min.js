/*
* Backbone.Siren v0.1.0
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
define(["jquery","underscore","backbone"],function(t,e,n){n.Siren=function(e,n){"use strict";function i(t,n){e.extend(this,t),this.parent=n}function a(t){return t.replace(/(\-[a-z])/g,function(t){return t.toUpperCase().replace("-","")})}function r(t){var e,n;return t.href?n=t.href:t.links?(e=t.links.filter(function(t){return!(!t.rel||!t.rel.filter(function(t){return"self"==t}).length)})[0],e&&(n=e.href)):(M('Missing href or "self" link'),n=""),n}function o(){return r(this._data)}function s(t){return t["class"]||[]}function l(t,n){return e.filter(t,function(t){return c(t,n)})}function c(t,e){var n=!0;return e.className&&(n=t.hasClass(e.className)),e.rel&&(n=t.rel()==e.rel),n}function u(t,e){var n=!0;return e.className&&(n=d(t,e.className)),e.name&&(n=t.name==e.name),n}function d(t,n){return e.indexOf(s(t),n)>-1}function h(t){return d(this._data,t)}function f(){return s(this._data)}function m(t){var n=this._data.links;return t&&(n=e.filter(n,function(n){return e.indexOf(n.rel,t)>-1})),n||[]}function p(n){var i=this,a=[],r=this.links(n);return e.each(r,function(e){a.push(t.getJSON(e.href,function(t){i.parseEntity(t)}))}),a}function v(t){var e=t.rel;return e&&(e=e[0],e=e.slice(e.lastIndexOf("/")+1,e.length)),e}function g(){return v(this._data)}function y(t){var n=this._actions;return t&&(n=e.filter(n,function(e){return u(e,t)})),n}function x(t){var i,a=this.getActionByName(t),r=this;return a&&(i={},e.each(a.fields,function(t){i[t.name]=r instanceof n.Model?r.get(t.name):r.meta(t.name)})),i}function b(t){return e.find(this._actions,function(e){return e.name==t})}function A(){return this._data.title}function _(){var t=this,i=[];return e.each(t._data.actions,function(r){var o=new n.Siren.Action(r,t);i.push(o),r.name?t[a(r.name)]=e.bind(o.execute,o):M("Action is missing a name, unable to add top level method",r)}),t._actions=i,i}var S={},w={add:function(t){return S[t.url()]=t},exists:function(t){return!!S[t.url()]},all:function(){return S}},M=function(){n.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return i.prototype={getFieldByName:function(t){return e.find(this.fields,function(e){return e.name==t})},execute:function(t){if(this.parent){var n={url:this.href,actionName:this.name,method:this.method,type:this.type,validate:!0,patch:!0,content:"application/vnd.siren+json"};return t=e.extend(n,t),this.parent.save(this.parent.getAllByAction(this.name),t)}}},{settings:{showWarnings:!0},store:w,warn:M,Action:i,Model:n.Model.extend({url:o,classes:f,hasClass:h,rel:g,title:A,actions:y,links:m,getActionByName:b,getAllByAction:x,parseActions:_,request:p,resolveEntities:function(n,i){var a=this,r=[];return e.each(n.entities,function(t){t.href&&"linked"==i.autoFetch||"all"==i.autoFetch?r.push(a.fetchEntity(t,i)):r.push(a.addEntity(t,i))}),t.when(r).done(function(){a.trigger("resolve",a)})},parse:function(t,e){return this._data=t,this._entities=[],this.resolveEntities(t,e),this.parseActions(e),t.properties},toJSON:function(){var t=e.clone(this.attributes),n=this.entities();return e.each(n,function(e){t[e.rel()]=e}),t},entities:function(t){var n=this,i=e.filter(this,function(t,i){return e.indexOf(n._entities,i)>-1});return t&&(i=l(i,t)),i},fetchEntity:function(e){var n=this;return t.getJSON(r(e),function(t){n.addEntity(t)})},parseEntity:function(t){var e;return d(t,"collection")?e=new n.Siren.Collection(t):d(t,"error")?M("@todo - errors"):(e=new n.Siren.Model(t),w.add(e)),e},addEntity:function(t){var e=this.parseEntity(t),n=e.rel();return this.set(n,e),this._entities.push(n),e},constructor:function(t,e){e=e||{},e.parse=!0,n.Model.call(this,t,e)}}),Collection:n.Collection.extend({url:o,classes:f,hasClass:h,title:A,rel:g,links:m,actions:y,getActionByName:b,getAllByAction:x,parseActions:_,request:p,toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},filter:function(t){return"function"==typeof t?e.filter(this,t):l(this,t)},parse:function(t,i){this._data=t,this._meta=t.properties||{};var a=[];return e.each(t.entities,function(t){var e=new n.Siren.Model(t);a.push(e),w.add(e)}),this.parseActions(i),a},meta:function(t){return this._meta[t]},constructor:function(t,e){e=e||{},e.parse=!0,n.Collection.call(this,t,e)}})}}(e,n),function(t,e){"use strict";e.Siren.validate={customPatterns:{},standardPatterns:{},setPatterns:function(e){var n=this,i="color date datetime datetime-local email month number range search tel time url week";t.each(e,function(t,e){-1==i.indexOf(e)?n.customPatterns[e]=t:n.standardPatterns[e]=t})}},t.extend(e.Siren.Model.prototype,{_validate:function(t,e){var n;return e.validate&&this.validate?(n=this.validationError=this.validate(t,e)||null,n&&this.trigger("invalid",this,n,e||{}),!(n&&!e.forceUpdate)):!0},validateEmptyField:function(t){return t.required?{valid:!1,valueMissing:!0}:{}},validateSubEntity:function(t,e){var n=e.action;return t._validate(t.getAllByAction(n),{validate:!0,actionName:n})?{}:{customError:!0,valid:!1}},validateType:function(t,n){var i={},a=n.type,r=e.Siren.validate.customPatterns[a]||e.Siren.validate.standardPatterns[a];return r?r.test(t)||(i.valid=!1,i.typeMismatch=!0):a&&"text"!=a&&"entity"!=a&&e.Siren.warn('Unable to validate type, "'+a+'" as it does not have a matching validation rule.'),i},validateConstraints:function(t,e){var n={},i=e.type;return e.pattern&&!RegExp(e.pattern).test(t)&&(n.valid=!1,n.patternMismatch=!0),"number"==i||"range"==i?(e.min&&e.min>t&&(n.valid=!1,n.rangeUnderflow=!0),e.max&&t>e.max&&(n.valid=!1,n.rangeOverflow=!0),e.step&&t%e.step&&(n.valid=!1,n.stepMismatch=!0)):"text email search password tel url".indexOf(i)>-1&&e.maxlength&&e.maxlength<t.length&&(n.valid=!1,n.tooLong=!0),n},validateOne:function(n,i){var a={valueMissing:!1,typeMismatch:!1,patternMismatch:!1,tooLong:!1,rangeUnderflow:!1,rangeOverflow:!1,stepMismatch:!1,badInput:!1,customError:!1,valid:!0};return n?(t.extend(a,this.validateType(n,i)),a.typeMismatch||(n instanceof e.Model?t.extend(a,this.validateSubEntity(n,i)):t.extend(a,this.validateConstraints(n,i)))):a=t.extend(a,this.validateEmptyField(i)),a},validate:function(e,n){n=n||{};var i=this,a=n.actionName,r=this.getActionByName(a),o={};return r?t.each(r.fields,function(t){var a=t.name,r=e[a],s=i.validateOne(r,t,n);s.valid||(o[a]=s)}):o["no-actions"]='There are no actions matching the name, "'+a+'"',t.isEmpty(o)?void 0:o}})}(e,n),function(t,e){"use strict";t.extend(e.Siren.Model.prototype,{})}(e,n),function(e,n){"use strict";function i(t,e){return e=e||{},{id:e.id||t.name+"-form",enctype:e.enctype||t.type,method:e.method||t.method,action:e.action||t.href,title:e.title||t.title,novalidate:!e.validation}}function a(t,n){n=n||{};var i=[],a=t.fields;return e.each(a,function(a){var r;"entity"!=a.type?(r=a.name,i.push(e.extend({value:t.parent.get(r)},a,n[r]))):"entity"==a.type&&console.log("@todo - how to handle sub-entity views?")}),i}n.Siren.FormView=n.View.extend({tagName:"form",events:{submit:"handleFormSubmit","change input, select":"handleFormElementChange"},handleFormSubmit:function(t){t.preventDefault(),this.model.getActionByName(this.action.name).execute()},handleFormElementChange:function(e){var n=t(e.target),i={};i[n.attr("name")]=n.val(),this.model.set(i,{validate:!!this.options.validateOnChange,actionName:this.action.name,forceUpdate:!0})},template:function(t){var n='<% _.each(fieldAttributes, function (field, fieldName) { %>                     <div>                         <label for="<%= field.id %>"><%= field.label %></label>                         <input type="<%= field.type %>" name="<%= field.name %>" id="<%= field.id %>" value="<%= field.value %>" />                     </div>                 <% }); %> <input type="submit" class="submitButton" />';return e.template(n)(t)},parseAction:function(t){var e;if(!t||!t.action)throw'Missing required property: "action"';if(e=t.action,!(e.parent instanceof n.Siren.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone.Siren Model';return{attributes:i(e,t.formAttributes),fieldAttributes:a(e,t.fieldAttributes),model:e.parent,action:e}},render:function(t){return this.$el.html(this.template(t))},_render:function(t){return this.render(t)},constructor:function(t){t=e.extend({},t,{validateOnChange:!0});var i=this.parseAction(t);n.View.call(this,e.extend({},t,i)),this.action=i.action,this._render(i)}})}(e,n)});
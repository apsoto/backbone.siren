/*
* Backbone.Siren v0.0.5
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
define(["jquery","underscore","backbone"],function(t,e,n){n.Siren=function(e,n){"use strict";function i(t,n){e.extend(this,t),this.parent=n}function r(t){return t.replace(/(\-[a-z])/g,function(t){return t.toUpperCase().replace("-","")})}function a(t){var e,n;return t.href?n=t.href:t.links?(e=t.links.filter(function(t){return!(!t.rel||!t.rel.filter(function(t){return"self"==t}).length)})[0],e&&(n=e.href)):(M('Missing href or "self" link'),n=""),n}function o(){return a(this._data)}function s(t){return t["class"]||[]}function c(t,n){return e.filter(t,function(t){return l(t,n)})}function l(t,e){var n=!0;return e.className&&(n=t.hasClass(e.className)),e.rel&&(n=t.rel()==e.rel),n}function u(t,e){var n=!0;return e.className&&(n=d(t,e.className)),e.name&&(n=t.name==e.name),n}function d(t,n){return e.indexOf(s(t),n)>-1}function f(t){return d(this._data,t)}function h(){return s(this._data)}function m(t){var n=this._data.links;return t&&(n=e.filter(n,function(n){return e.indexOf(n.rel,t)>-1})),n||[]}function p(n){var i=this,r=[],a=this.links(n);return e.each(a,function(e){r.push(t.getJSON(e.href,function(t){i.parseEntity(t)}))}),r}function v(t){var e=t.rel;return e&&(e=e[0],e=e.slice(e.lastIndexOf("/")+1,e.length)),e}function g(){return v(this._data)}function y(t){var n=this._actions;return t&&(n=e.filter(n,function(e){return u(e,t)})),n}function b(t){var i,r=this.getActionByName(t),a=this;return r&&(i={},e.each(r.fields,function(t){i[t.name]=a instanceof n.Model?a.get(t.name):a.meta(t.name)})),i}function A(t){return e.find(this._actions,function(e){return e.name==t})}function w(){return this._data.title}function _(){var t=this,i=[];return e.each(t._data.actions,function(a){var o=new n.Siren.Action(a,t);i.push(o),a.name?t[r(a.name)]=e.bind(o.execute,o):M("Action is missing a name, unable to add top level method",a)}),t._actions=i,i}var x={},N={add:function(t){return x[t.url()]=t},exists:function(t){return!!x[t.url()]},all:function(){return x}},M=function(){n.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return i.prototype={getFieldByName:function(t){return e.find(this.fields,function(e){return e.name==t})},execute:function(t){if(this.parent){var n={url:this.href,actionName:this.name,method:this.method,type:this.type,validate:!0,patch:!0,content:"application/vnd.siren+json"};return t=e.extend(n,t),this.parent.save(this.parent.getAllByAction(this.name),t)}}},{settings:{showWarnings:!0},store:N,warn:M,Action:i,Model:n.Model.extend({url:o,classes:h,hasClass:f,rel:g,title:w,actions:y,links:m,getActionByName:A,getAllByAction:b,parseActions:_,request:p,resolveEntities:function(n,i){var r=this,a=[];return e.each(n.entities,function(t){t.href&&"linked"==i.autoFetch||"all"==i.autoFetch?a.push(r.fetchEntity(t,i)):a.push(r.addEntity(t,i))}),t.when(a).done(function(){r.trigger("resolve",r)})},parse:function(t,e){return this._data=t,this._entities=[],this.resolveEntities(t,e),this.parseActions(e),t.properties},toJSON:function(){var t=e.clone(this.attributes),n=this.entities();return e.each(n,function(e){t[e.rel()]=e}),t},entities:function(t){var n=this,i=e.filter(this,function(t,i){return e.indexOf(n._entities,i)>-1});return t&&(i=c(i,t)),i},fetchEntity:function(e){var n=this;return t.getJSON(a(e),function(t){n.addEntity(t)})},parseEntity:function(t){var e;return d(t,"collection")?e=new n.Siren.Collection(t):d(t,"error")?M("@todo - errors"):(e=new n.Siren.Model(t),N.add(e)),e},addEntity:function(t){var e=this.parseEntity(t),n=e.rel();return this.set(n,e),this._entities.push(n),e},constructor:function(t,e){e=e||{},e.parse=!0,n.Model.call(this,t,e)}}),Collection:n.Collection.extend({url:o,classes:h,hasClass:f,title:w,rel:g,links:m,actions:y,getActionByName:A,getAllByAction:b,parseActions:_,request:p,toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},filter:function(t){return"function"==typeof t?e.filter(this,t):c(this,t)},parse:function(t,i){this._data=t,this._meta=t.properties||{};var r=[];return e.each(t.entities,function(t){var e=new n.Siren.Model(t);r.push(e),N.add(e)}),this.parseActions(i),r},meta:function(t){return this._meta[t]},constructor:function(t,e){e=e||{},e.parse=!0,n.Collection.call(this,t,e)}})}}(e,n),function(t,e){"use strict";e.Siren.validate={customPatterns:{},standardPatterns:{},setPatterns:function(e){var n=this,i="color date datetime datetime-local email month number range search tel time url week";if("object"!=typeof e)throw"Argument must be an object";t.each(e,function(t,e){-1==i.indexOf(e)?n.customPatterns[e]=t:n.standardPatterns[e]=t})}},t.extend(e.Siren.Model.prototype,{_validate:function(t,e){var n;return e.validate&&this.validate?(n=this.validationError=this.validate(t,e)||null)?(this.trigger("invalid",this,n,e||{}),!1):!0:!0},validateType:function(t,n){var i={},r=e.Siren.validate.customPatterns[n.customType]||e.Siren.validate.standardPatterns[n.type];return r?r.test(t)||(i.valid=!1,i.typeMismatch=!0):"text"!=n.type&&e.Siren.warn("Unrecognized input type: "+n.type),i},validateConstraints:function(t,e){var n={},i=e.type;return e.pattern&&!e.pattern.test(t)&&(n.valid=!1,n.patternMismatch=!0),"number"==i||"range"==i?(e.min&&e.min>t&&(n.valid=!1,n.rangeUnderflow=!0),e.max&&t>e.max&&(n.valid=!1,n.rangeOverflow=!0),e.step&&t%e.step&&(n.valid=!1,n.stepMismatch=!0)):e.maxlength&&e.maxlength<t.length&&(n.valid=!1,n.tooLong=!0),n},validateOne:function(e,n){var i={valueMissing:!1,typeMismatch:!1,patternMismatch:!1,tooLong:!1,rangeUnderflow:!1,rangeOverflow:!1,stepMismatch:!1,badInput:!1,customError:!1,valid:!0};return e?(t.extend(i,this.validateType(e,n)),t.extend(i,this.validateConstraints(e,n))):n.required&&(i.valid=!1,i.valueMissing=!0),i},validate:function(n,i){var r,a=this,o={};return r=this.getActionByName(i.actionName),r?t.isEmpty(n)&&(o["no-writable-fields"]='Malformed Siren: There were no writable fields for action "'+i.actionName+'"'):o["no-actions"]='Malformed Siren: There are no actions matching the name, "'+i.actionName+'"',t.each(n,function(t,n){var s,c,l,u;t instanceof e.Model?(s=r.getFieldByName(n),c=s.action,t._validate(t.getAllByAction(c),{validate:!0,actionName:c}),u=t.validationError,u&&(o[n]=u)):(l=a.validateOne(t,r.getFieldByName(n),i),l.valid||(o[n]=l))}),t.isEmpty(o)?void 0:o}})}(e,n),function(t,e){"use strict";t.extend(e.Siren.Model.prototype,{})}(e,n),function(e,n){"use strict";function i(t,e){return e=e||{},{id:e.id||t.name+"-form",enctype:e.enctype||t.type,method:e.method||t.method,action:e.action||t.href,title:e.title||t.title,novalidate:!e.validation}}function r(t,n){n=n||{};var i=[],r=t.fields;return e.each(r,function(r){var a;"entity"!=r.type?(a=r.name,i.push(e.extend({value:t.parent.get(a)},r,n[a]))):"entity"==r.type&&console.log("@todo - how to handle sub-entity views?")}),i}n.Siren.FormView=n.View.extend({tagName:"form",events:{submit:"handleFormSubmit","change input, select":"handleFormElementChange"},handleFormSubmit:function(t){t.preventDefault(),this.model.getActionByName(this.action.name).execute()},handleFormElementChange:function(e){var n=t(e.target),i={};i[n.attr("name")]=n.val(),this.model.set(i)},template:function(t){var n='<% _.each(fieldAttributes, function (field, fieldName) { %>                     <div>                         <label for="<%= field.id %>"><%= field.label %></label>                         <input type="<%= field.type %>" name="<%= field.name %>" id="<%= field.id %>" value="<%= field.value %>" />                     </div>                 <% }); %> <input type="submit" class="submitButton" />';return e.template(n)(t)},parseAction:function(t){var e;if(!t||!t.action)throw'Missing required property: "action"';if(e=t.action,!(e.parent instanceof n.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone Model';return{attributes:i(e,t.formAttributes),fieldAttributes:r(e,t.fieldAttributes),model:e.parent,action:e}},render:function(t){return this.$el.html(this.template(t))},_render:function(t){return this.render(t)},constructor:function(t){var e=this.parseAction(t);n.View.call(this,e),this.action=e.action,this._render(e)}})}(e,n)});
/*
* Backbone.Siren v0.0.5
*
* Copyright (c) 2013 Kiva Microfunds
* Licensed under the MIT license.
* https://github.com/kiva/backbone.siren/blob/master/license.txt
*/
Backbone.Siren=function(t,e){"use strict";function n(e,n){t.extend(this,e),this.parent=n}function i(t){return t.replace(/(\-[a-z])/g,function(t){return t.toUpperCase().replace("-","")})}function r(t){var e,n;return t.href?n=t.href:t.links?(e=t.links.filter(function(t){return!(!t.rel||!t.rel.filter(function(t){return"self"==t}).length)})[0],e&&(n=e.href)):(N('Missing href or "self" link'),n=""),n}function a(){return r(this._data)}function o(t){return t["class"]||[]}function s(e,n){return t.filter(e,function(t){return c(t,n)})}function c(t,e){var n=!0;return e.className&&(n=t.hasClass(e.className)),e.rel&&(n=t.rel()==e.rel),n}function l(t,e){var n=!0;return e.className&&(n=u(t,e.className)),e.name&&(n=t.name==e.name),n}function u(e,n){return t.indexOf(o(e),n)>-1}function d(t){return u(this._data,t)}function f(){return o(this._data)}function h(e){var n=this._data.links;return e&&(n=t.filter(n,function(n){return t.indexOf(n.rel,e)>-1})),n||[]}function m(e){var n=this,i=[],r=this.links(e);return t.each(r,function(t){i.push($.getJSON(t.href,function(t){n.parseEntity(t)}))}),i}function p(t){var e=t.rel;return e&&(e=e[0],e=e.slice(e.lastIndexOf("/")+1,e.length)),e}function v(){return p(this._data)}function g(e){var n=this._actions;return e&&(n=t.filter(n,function(t){return l(t,e)})),n}function y(n){var i,r=this.getActionByName(n),a=this;return r&&(i={},t.each(r.fields,function(t){i[t.name]=a instanceof e.Model?a.get(t.name):a.meta(t.name)})),i}function b(e){return t.find(this._actions,function(t){return t.name==e})}function A(){return this._data.title}function w(){var n=this,r=[];return t.each(n._data.actions,function(a){var o=new e.Siren.Action(a,n);r.push(o),a.name?n[i(a.name)]=t.bind(o.execute,o):N("Action is missing a name, unable to add top level method",a)}),n._actions=r,r}var _={},x={add:function(t){return _[t.url()]=t},exists:function(t){return!!_[t.url()]},all:function(){return _}},N=function(){e.Siren.settings.showWarnings&&console&&console.warn.apply(console,arguments)};return n.prototype={getFieldByName:function(e){return t.find(this.fields,function(t){return t.name==e})},execute:function(e){if(this.parent){var n={url:this.href,actionName:this.name,method:this.method,type:this.type,validate:!0,patch:!0,content:"application/vnd.siren+json"};return e=t.extend(n,e),this.parent.save(this.parent.getAllByAction(this.name),e)}}},{settings:{showWarnings:!0},store:x,warn:N,Action:n,Model:e.Model.extend({url:a,classes:f,hasClass:d,rel:v,title:A,actions:g,links:h,getActionByName:b,getAllByAction:y,parseActions:w,request:m,resolveEntities:function(e,n){var i=this,r=[];return t.each(e.entities,function(t){t.href&&"linked"==n.autoFetch||"all"==n.autoFetch?r.push(i.fetchEntity(t,n)):r.push(i.addEntity(t,n))}),$.when(r).done(function(){i.trigger("resolve",i)})},parse:function(t,e){return this._data=t,this._entities=[],this.resolveEntities(t,e),this.parseActions(e),t.properties},toJSON:function(){var e=t.clone(this.attributes),n=this.entities();return t.each(n,function(t){e[t.rel()]=t}),e},entities:function(e){var n=this,i=t.filter(this,function(e,i){return t.indexOf(n._entities,i)>-1});return e&&(i=s(i,e)),i},fetchEntity:function(t){var e=this;return $.getJSON(r(t),function(t){e.addEntity(t)})},parseEntity:function(t){var n;return u(t,"collection")?n=new e.Siren.Collection(t):u(t,"error")?N("@todo - errors"):(n=new e.Siren.Model(t),x.add(n)),n},addEntity:function(t){var e=this.parseEntity(t),n=e.rel();return this.set(n,e),this._entities.push(n),e},constructor:function(t,n){n=n||{},n.parse=!0,e.Model.call(this,t,n)}}),Collection:e.Collection.extend({url:a,classes:f,hasClass:d,title:A,rel:v,links:h,actions:g,getActionByName:b,getAllByAction:y,parseActions:w,request:m,toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},filter:function(e){return"function"==typeof e?t.filter(this,e):s(this,e)},parse:function(n,i){this._data=n,this._meta=n.properties||{};var r=[];return t.each(n.entities,function(t){var n=new e.Siren.Model(t);r.push(n),x.add(n)}),this.parseActions(i),r},meta:function(t){return this._meta[t]},constructor:function(t,n){n=n||{},n.parse=!0,e.Collection.call(this,t,n)}})}}(_,Backbone),function(t,e){"use strict";e.Siren.validate={customPatterns:{},standardPatterns:{},setPatterns:function(e){var n=this,i="color date datetime datetime-local email month number range search tel time url week";if("object"!=typeof e)throw"Argument must be an object";t.each(e,function(t,e){-1==i.indexOf(e)?n.customPatterns[e]=t:n.standardPatterns[e]=t})}},t.extend(e.Siren.Model.prototype,{_validate:function(t,e){var n;return e.validate&&this.validate?(n=this.validationError=this.validate(t,e)||null)?(this.trigger("invalid",this,n,e||{}),!1):!0:!0},validateType:function(t,n){var i={},r=e.Siren.validate.customPatterns[n.customType]||e.Siren.validate.standardPatterns[n.type];return r?r.test(t)||(i.valid=!1,i.typeMismatch=!0):"text"!=n.type&&e.Siren.warn("Unrecognized input type: "+n.type),i},validateConstraints:function(t,e){var n={},i=e.type;return e.pattern&&!e.pattern.test(t)&&(n.valid=!1,n.patternMismatch=!0),"number"==i||"range"==i?(e.min&&e.min>t&&(n.valid=!1,n.rangeUnderflow=!0),e.max&&t>e.max&&(n.valid=!1,n.rangeOverflow=!0),e.step&&t%e.step&&(n.valid=!1,n.stepMismatch=!0)):e.maxlength&&e.maxlength<t.length&&(n.valid=!1,n.tooLong=!0),n},validateOne:function(e,n){var i={valueMissing:!1,typeMismatch:!1,patternMismatch:!1,tooLong:!1,rangeUnderflow:!1,rangeOverflow:!1,stepMismatch:!1,badInput:!1,customError:!1,valid:!0};return e?(t.extend(i,this.validateType(e,n)),t.extend(i,this.validateConstraints(e,n))):n.required&&(i.valid=!1,i.valueMissing=!0),i},validate:function(n,i){var r,a=this,o={};return r=this.getActionByName(i.actionName),r?t.isEmpty(n)&&(o["no-writable-fields"]='Malformed Siren: There were no writable fields for action "'+i.actionName+'"'):o["no-actions"]='Malformed Siren: There are no actions matching the name, "'+i.actionName+'"',t.each(n,function(t,n){var s,c,l,u;t instanceof e.Model?(s=r.getFieldByName(n),c=s.action,t._validate(t.getAllByAction(c),{validate:!0,actionName:c}),u=t.validationError,u&&(o[n]=u)):(l=a.validateOne(t,r.getFieldByName(n),i),l.valid||(o[n]=l))}),t.isEmpty(o)?void 0:o}})}(_,Backbone),function(t,e){"use strict";t.extend(e.Siren.Model.prototype,{})}(_,Backbone),function(t,e){"use strict";function n(t,e){return e=e||{},{id:e.id||t.name+"-form",enctype:e.enctype||t.type,method:e.method||t.method,action:e.action||t.href,title:e.title||t.title,novalidate:!e.validation}}function i(e,n){n=n||{};var i=[],r=e.fields;return t.each(r,function(r){var a;"entity"!=r.type?(a=r.name,i.push(t.extend({value:e.parent.get(a)},r,n[a]))):"entity"==r.type&&console.log("@todo - how to handle sub-entity views?")}),i}e.Siren.FormView=e.View.extend({tagName:"form",events:{submit:"handleFormSubmit","change input, select":"handleFormElementChange"},handleFormSubmit:function(t){t.preventDefault(),this.model.getActionByName(this.action.name).execute()},handleFormElementChange:function(t){var e=$(t.target),n={};n[e.attr("name")]=e.val(),this.model.set(n)},template:function(e){var n='<% _.each(fieldAttributes, function (field, fieldName) { %>                 <div>                     <label for="<%= field.id %>"><%= field.label %></label>                     <input type="<%= field.type %>" name="<%= field.name %>" id="<%= field.id %>" value="<%= field.value %>" />                 </div>             <% }); %> <input type="submit" class="submitButton" />';return t.template(n)(e)},parseAction:function(t){var r;if(!t||!t.action)throw'Missing required property: "action"';if(r=t.action,!(r.parent instanceof e.Model))throw'Action object either missing required "parent" or "parent" is not a Backbone Model';return{attributes:n(r,t.formAttributes),fieldAttributes:i(r,t.fieldAttributes),model:r.parent,action:r}},render:function(t){return this.$el.html(this.template(t))},_render:function(t){return this.render(t)},constructor:function(t){var n=this.parseAction(t);e.View.call(this,n),this.action=n.action,this._render(n)}})}(_,Backbone);